version: '3'

vars:
  kernel_cmdline_append: "rw"
  result_folder: ./build
  disc_image: ./build/image.raw
  initrd_img: ./build/initrd.img
  kernel: ./build/vmlinuz

env:
  SHELL : /bin/bash

tasks:
  build_initrd:
    desc: The initrd image is build using the initrd generator.
    cmds:
      - echo "Build initrd.img..."
      - mkdir -p {{.result_folder}}
      - initrd_generator {{.initrd_spec}} {{.result_folder}} 2>&1 | tee {{.initrd_img}}.log
    sources:
       - ./{{.initrd_spec}}
    generates:
       - ./{{.initrd_img}}

  build_boot:
    desc: The boot generator is used to extract the kernel image for a Debian package.
    cmds:
      - echo "Get kernel binary..."
      - mkdir -p {{.result_folder}}
      - set -o pipefail && boot_generator {{.boot_spec}} {{.result_folder}} 2>&1 | tee {{.kernel}}.log
      - mv ./{{.kernel}}-* ./{{.kernel}} || true
    preconditions:
       - test -f {{.boot_spec}}
    sources:
       - ./{{.boot_spec}}
    generates:
       - ./{{.kernel}}

  build_root_base:
    desc: |
            Use the root generator to build the base root filesystem tarball.
            This fist step only installs the specified packages. User configuration
            is done as a second step, because the build of this tarball is quite 
            time consuming and configuration is fast. This is an optimization for 
            the image development process.
    cmds:
      - echo "Build root.tar..."
      - mkdir -p {{.result_folder}}
      - set -o pipefail && root_generator --no-config {{.root_filesystem_spec}} {{.result_folder}} 2>&1 | tee {{.base_tarball}}.log
    preconditions: 
       - test -f {{.root_filesystem_spec}}
    sources: 
       - ./{{.root_filesystem_spec}}
    generates: 
       - ./{{.base_tarball}}
  
  build_rootfs:
    desc: |
           The root configurator is used to run the user configuration scripts
           as a separate step in the build process.
    deps: [build_root_base]
    cmds: 
      - echo "Configuring {{.base_tarball}} as {{.root_tarball}}..."
      - mkdir -p  {{.result_folder}}
      - set -o pipefail && root_configurator {{.root_filesystem_spec}} {{.base_tarball}} {{.root_tarball}} 2>&1 | tee {{.root_tarball}}.log
    preconditions: 
       - test -f {{.root_filesystem_spec}}
    sources: 
       - ./{{.root_filesystem_spec}}
    generates: 
       - ./{{.root_tarball}}

  build_image:
    desc: Use embdgen to build the disc image
    deps: [build_rootfs, build_boot, build_initrd]
    cmds: 
      - echo "Build image..."
      - mkdir -p  {{.result_folder}}
      - set -o pipefail && embdgen -o ./{{.disc_image}} {{.partition_layout}} 2>&1 | tee {{.disc_image}}.log
    preconditions: 
       - test -f {{.partition_layout}}
    sources: 
       - ./{{.partition_layout}}
    generates: 
       - ./{{.disc_image}}

  sysroot_tarball:
    desc: The root generator is used to build a sysroot variant of the root filesystem.
    cmds: 
      - echo "Build sysroot.tar..."
      - mkdir -p {{.result_folder}}
      - set -o pipefail && root_generator --sysroot --no-config {{.root_filesystem_spec}} {{.result_folder}} 2>&1 | tee {{.sysroot_tarball}}.log
    preconditions: 
      - test -f {{.root_filesystem_spec}}
    sources:
      - root.yaml
    generates: 
      - ./{{.sysroot_tarball}}

  install_sysroot:
    desc: Install sysroot_tarball to workspace
    deps: [sysroot_tarball]
    cmds: 
      - rm -rf /workspace/sysroot_{{.arch}}/*
      - tar xf {{.sysroot_tarball}} -C /workspace/sysroot_{{.arch}}/ || true

  edit_base:
    desc: Opens a shell for manual base root configuration
    cmds: 
      - echo "Extacting base root tarball..."
      - mkdir -p {{.result_folder}}/root
      - fakeroot -s {{.result_folder}}/fakedit -- tar xf {{.base_tarball}} -C {{.result_folder}}/root
      - echo "Open edit shell..."
      - cd {{.result_folder}}/root && fakeroot -i ../fakedit -s ../fakeedit
      - echo "Re-packing root tarball..."
      - defer: rm -f {{.base_tarball}}.old
      - mv {{.base_tarball}} {{.base_tarball}}.old
      - cd {{.result_folder}}/root && fakeroot -i ../fakedit -s ../fakedit -- tar cf ../../{{.base_tarball}} .
      - defer: rm -rf {{.result_folder}}/root
    
  edit_root:
    desc: Opens a shell for manual root configuration
    cmds: 
      - echo "Extacting root tarball..."
      - mkdir -p {{.result_folder}}/root
      - fakeroot -s {{.result_folder}}/fakedit -- tar xf {{.root_tarball}} -C {{.result_folder}}/root
      - echo "Open edit shell..."
      - cd {{.result_folder}}/root && fakeroot -i ../fakedit -s ../fakeedit
      - echo "Re-packing root tarball..."
      - defer: rm -f {{.root_tarball}}.old
      - mv {{.root_tarball}} {{.root_tarball}}.old
      - cd {{.result_folder}}/root && fakeroot -i ../fakedit -s ../fakedit -- tar cf ../../{{.root_tarball}} .
      - defer: rm -rf {{.result_folder}}/root

  clean:
    desc: Remove build artifacts
    cmds:
      - rm -rf {{.result_folder}}

  mrproper:
    desc: Remove build artifacts and clean all caches
    cmds:
      - rm -rf {{.result_folder}}
      - rm -rf /workspace/state

