# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

vars:
  common_tasks: /workspace/images/tasks/
  result_folder: '{{.result_folder | default "./build/"}}'

includes:
  gen:
    taskfile: '{{.common_tasks}}Generic.yml'
    flatten: true
  root: '{{.common_tasks}}RootGenerator.yml'
  embdgen: '{{.common_tasks}}Embdgen.yml'
  qemu: '{{.common_tasks}}QEMU.yml'

tasks:
  default:
    aliases: [build]
    desc: Build the VM image
    vars:
      root_tarball: '{{.root_tarball | default "boot_root.config.tar"}}'
      disc_image: '{{.disc_image | default "domu.img"}}'
    cmds:
      # Prepare root filesystem
      - task: root:build
      - task: root:config
      # Generate DomU image from artifacts
      - task: embdgen:build
        vars:
          disc_image: '{{.disc_image}}'
      - ./run_amd_install.sh
    method: none

  run_qemu:
    desc: Run DomU image using QEMU x86_64 with EFI.
    vars:
      disc_image: '{{.disc_image | default "domu.img"}}'
    cmds:
      - task: qemu:run_amd64_efi
        vars:
          efi_image: '{{.disc_image}}'
    method: none
