# Testing

[This repository](https://github.com/Elektrobit/ebcl_template/robot_tests)
provides Robot Framework tests for the images, and a
[Robot Framework library](https://github.com/Elektrobit/ebcl_template/robot_tests/lib)
which helps to write _environment independent_ tests.

The core interfaces of the test library are:

- [Image](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/Image.py):
  Abstraction for building images.
- [Power](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/Power.py):
  Abstraction for power state management.
- [Comm](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/Comm.py):
  Abstraction for image interaction.

## Image

The _Image_ class provides a generic interface for building images.
To implement this, it makes use of an
[image_interface](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/interfaces/image_interface.py)
in the background.
The _image_interface_ provides implementations of the _Build_ and _Clear_ keywords
for a specific build framework like our taskfiles.

A example using the _Image_ class is:

```
Clear    ${path}    task mrproper
${image}=    Build    ${path}
```

The first line _Clear_ the build folder,
i.e. removes previous build artifacts to ensure a clean build.
It makes use of a specific command, `task mrproper`, instead of relying on the defaults.
The `task mrproper` also deletes all local caches,
to simulate a clean workspace and ensures that also the download of all used packages works.

The _Build_ keyword runs the image build, relying on defaults.
The _path_ parameter gives the subfolder containing the image specification.
The _Image_ class also provides an init parameter to set a base path for all images.

## Power

The _Power_ class provides a generic interface for running images.
To implement this, it makes use of an
[power_interface](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/interfaces/power_interface.py)
in the background.
The _power_interface_ provides implementations of the _Power On_ and _Power Off_ keywords.
The [power_qemu implementation](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/interfaces/power_qemu.py)
implements these keywords for running images in QEMU.

A example using the _Power_ class to run an image:

```
${process}=    Power On    ${image}
```

The _Power On_ keyword gets a path to an image file, and runs this image using QEMU.
To do this, it makes use of the `task run_qemu` command.
This command is executed in a fresh shell, and the shell is the returned process.
This process can be used afterwards with _Comm_ to interact with the running image.

Hardware interfaces may use setup specific commands to power on an attached hardware,
and should provide a process wrapping a serial connection session.

The _Power Off_ keyword shall turn of the hardware.
In case of QEMU, it kills the process.
In case of a real hardware, it should do a power cut.

## Comm

The _Comm_ class provides a generic interface for interacting with the running image,
and is the base for easy transferable and hardware independent tests.
In the background, it makes use of the 
[ProcIO](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/util/proc_io.py)
class to send commands and collect the outputs.
The _Connect_ keyword attaches to the process providing the serial interface,
and the _Disconnect_ keyword detaches from the process and stops it.
The test keywords provided by _Comm_ are:

- _Login To Vm_: This keyword automates the login to a getty session.
  It's typically used after _Power On_ and _Connect_.
- _Execute_: This keyword runs the given command and provides the output
  generated by the command. It detects the end of the output by using an
  `echo` command, so it requires a shell session and a shell environment
  which has the `echo` command.
- _Wait For Line_: This keyword reads the lines appearing at the serial terminal,
  and search for the given substring in the lines. If a match is found, all lines
  until the match, including the matching line, is returned. It can be used to
  wait for a given log signalling an expected system state.
- _Wait for Regex_: This keyword is like _Wait For Line_, but searches using
  a regular expression. This may be necessary if the searched log is more complex.

These keywords build on low level keywords which should not be needed for tests.
These low level keywords are:

- _Send Message_: Sends a message to the serial terminal. A return ("\\n") is
  automatically added.
- _Send Key_: Sends a key to the serial terminal.
- _Read Line_: Reads the next output line from the serial terminal.

## Util

The _Util_ class provides useful more complex keywords implemented in Python.
These keywords are:

- _Filter Lines Containing_: This keyword filters lines containing a given string
  from a string containing multiple lines. It's used to filter the startup and
  init manager logs for known lines which would be detected as issue.

## Performance

See [Performance](./performance.md).

## Other classes

The test library contains some more helper classes.
These classes are not intended for usage in tests and the interface may change over time.

- [ProcIO](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/util/proc_io.py):
  Helper class for interfacing with a running subprocess. It runs threads to read and tag
  the lines generated by the process, and provides methods for sending messages to the process.
- [Fakeroot](https://github.com/Elektrobit/ebcl_template/robot_tests/lib/Fakeroot.py):
  Fakeroot offers methods to run commands on the test host environment.
